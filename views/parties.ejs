<%- include('base'); %>
  <style>
    .example-wrapper { font: 18px/1.5 sans-serif; background-color: #F5F5F5;}
    .example-wrapper code { background: #F5F5F5; padding: 2px 6px; }
</style>

  <body>
    <div class="example-wrapper">
        <table class="table table-striped table-hover table-bordered">
            <thead class="table-dark">
                <tr>
                    <th style="text-align: center; vertical-align: middle;">Adversaire 1</th>
                    <th style="text-align: center; vertical-align: middle;">Adversaire 2</th>
                    
                    <th style="text-align: center; vertical-align: middle;">
                        <button type="button" class="btn btn-success"  name="ajout" id="ajout" data-bs-toggle="modal" data-bs-target="#modal_modifier"
                            onclick="modifier()"> 
                             Ajouter une partie
                        </button>                       
                    </th>
                  
                </tr>
            </thead>
            <tbody id="parties">
                <% parties.forEach(function(partie) { %>
                    <tr>
                        <td style="text-align: center; vertical-align: middle;"><%= partie.prenom1 %> <%= partie.nom1 %></td>
                        <td style="text-align: center; vertical-align: middle;"><%= partie.prenom2 %> <%= partie.nom2 %></td>
                        
                        <td style="text-align: center; vertical-align: middle;"> 
                            <button type="button" class="btn btn-warning" id="modifParties"  name="modifParties"  data-bs-toggle="modal" data-bs-target="#modal_modifier" onclick="modifier('<%= partie.id %>','i1_<%= partie.adversaire1 %>','i2_<%= partie.adversaire2 %>')"> 
                                Modifier
                            </button>
                            <button type="button" class="btn btn-danger"  name="supPartie" id="supPartie" data-bs-toggle="modal" data-bs-target="#modal_supprimer" onclick="supprimer('<%= partie.id %>')">Supprimer</button>
                        </td>
                       
                    </tr> 
                <% }); %>
            </tbody>
        </table>
       
        <form  method="post" id="formSup">
            <div class="modal fade" id="modal_supprimer" tabindex="-1" data-bs-keyboard="false" aria-labelledby="exampleModalCenterTitle" aria-hidden="true" >
                <div class="modal-dialog" >
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="supModalLongTitle"> Suppression de la série </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="container-fluid">
                                <p id="pModalAutre">Êtes-vous sur de vouloir supprimer la partie?</p>
                            </div>     
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="modalNon">Non</button>  
                            <button type="button" class="btn btn-danger delete"  id="submitAutre">Oui</button>
                        </div>      
                    </div>
                </div>
            </div>
        </form>
        <form method="post" id="form">
            <div class="modal fade" id="modal_modifier" tabindex="-1" data-bs-keyboard="true" 
                aria-labelledby="exampleModalCenterTitle" aria-hidden="true" >  
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLongTitle"> Modification de la série </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="container-fluid">
                                        <p>
                                            Adversaire 1
                                            <select name="concurrant1" id="concurrant1" class="form-select">
                                                <option id="i1_base" value="">--Please choose an option--</option>
                                                <% concurrants.forEach(function(concurrant) { %>
                                                <option id="i1_<%= concurrant.id %>" value="c1_<%= concurrant.id %>" ><%= concurrant.nom %></option>
                                                <% }); %>
                                            </select>        
                                        </p>
                                        <p>
                                            Adversaire 2
                                            <select name="concurrant2" id="concurrant2" class="form-select">
                                                <option id="i2_base" value="">--Please choose an option--</option>
                                                <% concurrants.forEach(function(concurrant) { %>
                                                <option id="i2_<%= concurrant.id %>" value="c2_<%= concurrant.id %>"> <%= concurrant.prenomnom %> <%= concurrant.nom %></option>
                                                <% }); %>
                                            </select>     
                                        </p>
                                
                                </div>                
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary"  id="submit" onclick="addPartie()">Valider</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="modalNon" >Non</button>
                            </div>
                    
                        </div>
                    </div>
                </div>
            </div>
        </form>
        
        
    </body>
    <script src="../javascript/helpers.js" ></script>
    <script>
        function modifier(id,index1,index2){
            
            
            concurrant1=document.getElementById('concurrant1')
            concurrant2=document.getElementById('concurrant2')
            if(id!=null){
                select(concurrant1,index1)
                select(concurrant2,index2)
                document.getElementById('exampleModalLongTitle').innerHTML="Modification de la partie" ;
                document.getElementById('submit').setAttribute("onclick",'modifPartie("'+id+'")')
            }
            else{
                select(concurrant1,"i1_base")
                select(concurrant2,"i2_base")
                document.getElementById('exampleModalLongTitle').innerHTML="Ajout d'une partie" ;
                document.getElementById('submit').setAttribute("onclick",'addPartie()')
               
                
            }
            console.log(document.getElementById('submit'))
        }

        function select(list,index){
            if(list!=null){
                Array.from(list.options).forEach(function(e){
                    if(e.getAttribute('id')==index ){
                        
                            e.selected=true
                    }
                    else if(e.selected){
                        e.selected=false
                    }
                })
        
            }
        }

        function supprimer(id){
            document.getElementById('submitAutre').setAttribute('onclick',"supprPartie('"+id+"')")
        }

        function reload(){
            
            request=new XMLHttpRequest()
            request.onreadystatechange=function(){
                if(request.readyState===XMLHttpRequest.DONE){
                    if(request.status===200){
                        
                        populate("parties",JSON.parse(request.responseText))
                    }
                    
                }
                
            }
            request.open('GET','/api/parties',true)
            request.send()

        }
        function addPartie(){
            
            request=new XMLHttpRequest()
            request.onreadystatechange=function(){
                
                if(request.readyState===XMLHttpRequest.DONE){
                    if(request.status===200){
                        
                        reload()
                    }
                    
                }
                
            }
            request.open('POST','/api/add_partie',true)
            request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            request.send(encode([["concurrant1",document.getElementById('concurrant1').selectedOptions[0].getAttribute('id')],
            ["concurrant2",document.getElementById('concurrant2').selectedOptions[0].getAttribute('id')]]))

        }

        function modifPartie(id){
            request=new XMLHttpRequest()
            request.onreadystatechange=function(){
                if(request.readyState===XMLHttpRequest.DONE){
                    if(request.status===200){
                        
                        reload()
                    }
                    
                }
            }
            request.open('POST','/api/modif_partie',true)
            request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            request.send(encode([["concurrant1",document.getElementById('concurrant1').selectedOptions[0].getAttribute('id')],
            ["concurrant2",document.getElementById('concurrant2').selectedOptions[0].getAttribute('id')],['id',id]]))
        }

        function supprPartie(id){
            request=new XMLHttpRequest()
            request.onreadystatechange=function(){
                if(request.readyState===XMLHttpRequest.DONE){
                    if(request.status===200){
                        
                        reload()
                    }
                    
                }
            }
            request.open('POST','/api/suppr_partie',true)
            request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            request.send(encode([['id',id]]))
        }
    </script>    
</html>